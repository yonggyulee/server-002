DO $EF$
BEGIN
    IF NOT EXISTS(SELECT 1 FROM pg_namespace WHERE nspname = 'inference') THEN
        CREATE SCHEMA inference;
    END IF;
END $EF$;

CREATE TABLE inference.server (
    id character varying(256) NOT NULL,
    address inet NOT NULL,
    os_type character varying(256) NOT NULL,
    os_version character varying(256) NOT NULL,
    cpu_count integer NOT NULL DEFAULT (0),
    cpu_memory bigint NOT NULL DEFAULT (0),
    gpu_name character varying(256) NULL,
    gpu_count bigint NOT NULL DEFAULT (0),
    gpu_memory bigint NOT NULL DEFAULT (0),
    properties jsonb NULL,
    description text NULL,
    CONSTRAINT pk_server PRIMARY KEY (id)
);


CREATE TABLE inference.volume (
    id character varying(256) NOT NULL,
    title character varying(256) NOT NULL,
    type text NOT NULL,
    uri character varying(256) NOT NULL,
    usage bigint NOT NULL DEFAULT 0,
    capacity bigint NOT NULL DEFAULT 0,
    properties jsonb NULL,
    description text NULL,
    CONSTRAINT pk_volume PRIMARY KEY (id)
);


CREATE TABLE inference.model (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    volume_id character varying(256) NOT NULL,
    task_name varchar(256) NOT NULL,
    network_name varchar(256) NOT NULL,
    model_name varchar(256) NOT NULL,
    properties jsonb NULL,
    description text NULL,
    CONSTRAINT pk_model PRIMARY KEY (id),
    CONSTRAINT fk_model_volume_volume_id FOREIGN KEY (volume_id) REFERENCES inference.volume (id) ON DELETE CASCADE
);


CREATE TABLE inference.model_version (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    model_id bigint NOT NULL,
    version varchar(32) NOT NULL,
    filename varchar(512) NOT NULL,
    load_date timestamp with time zone NULL,
    create_date timestamp with time zone NOT NULL DEFAULT (now()),
    update_date timestamp with time zone NOT NULL DEFAULT (now()),
    load_user varchar(256) NULL,
    create_user varchar(256) NOT NULL,
    update_user varchar(256) NOT NULL,
    status varchar(100) NULL,
    properties jsonb NULL,
    description text NULL,
    CONSTRAINT pk_model_version PRIMARY KEY (id),
    CONSTRAINT fk_model_version_model_model_id FOREIGN KEY (model_id) REFERENCES inference.model (id) ON DELETE CASCADE
);


CREATE TABLE inference.default_model_version (
    id bigint GENERATED BY DEFAULT AS IDENTITY,
    model_id bigint NOT NULL,
    model_version_id bigint NOT NULL,
    CONSTRAINT pk_default_model_version PRIMARY KEY (id),
    CONSTRAINT fk_default_model_version_model_model_id FOREIGN KEY (model_id) REFERENCES inference.model (id) ON DELETE CASCADE,
    CONSTRAINT fk_default_model_version_model_version_model_version_id FOREIGN KEY (model_version_id) REFERENCES inference.model_version (id) ON DELETE CASCADE
);


CREATE TABLE inference.worker (
    id varchar(256) NOT NULL,
    model_version_id bigint NOT NULL,
    port integer NOT NULL,
    usage bigint NOT NULL DEFAULT 0,
    serving_type varchar(256) NOT NULL,
    server_id character varying(256) NOT NULL,
    cpu_count integer NOT NULL DEFAULT (0),
    cpu_memory bigint NOT NULL DEFAULT (0),
    gpu_count integer NOT NULL DEFAULT (0),
    gpu_memory bigint NOT NULL DEFAULT (0),
    properties jsonb NULL,
    description text NULL,
    CONSTRAINT pk_worker PRIMARY KEY (id),
    CONSTRAINT fk_worker_model_versions_model_version_id FOREIGN KEY (model_version_id) REFERENCES inference.model_version (id) ON DELETE CASCADE,
    CONSTRAINT fk_worker_server_server_id FOREIGN KEY (server_id) REFERENCES inference.server (id) ON DELETE CASCADE
);


INSERT INTO inference.server (id, address, cpu_count, cpu_memory, description, gpu_name, os_type, os_version, properties)
VALUES ('server_1', INET '192.168.70.32', 1, 512000000, NULL, NULL, 'CentOS', '7', NULL);


INSERT INTO inference.volume (id, capacity, description, properties, title, type, uri)
VALUES ('volume1', 100000000, NULL, NULL, 'Volume1', 'model', 'c:/mirero/volumes/inference/volume1');
INSERT INTO inference.volume (id, capacity, description, properties, title, type, uri)
VALUES ('volume2', 100000000, NULL, NULL, 'Volume2', 'model', 'c:/mirero/volumes/inference/volume2');
INSERT INTO inference.volume (id, capacity, description, properties, title, type, uri)
VALUES ('volume3', 100000000, NULL, NULL, 'Volume3', 'model', 'c:/mirero/volumes/inference/volume3');


INSERT INTO inference.model (id, description, model_name, network_name, properties, task_name, volume_id)
VALUES (1, NULL, 'model_1', 'resnet', NULL, 'object_detection', 'volume1');
INSERT INTO inference.model (id, description, model_name, network_name, properties, task_name, volume_id)
VALUES (2, NULL, 'model_2', 'fcnn', NULL, 'object_detection', 'volume1');
INSERT INTO inference.model (id, description, model_name, network_name, properties, task_name, volume_id)
VALUES (3, NULL, 'model_3', 'deeplabv3', NULL, 'object_detection', 'volume1');
INSERT INTO inference.model (id, description, model_name, network_name, properties, task_name, volume_id)
VALUES (4, NULL, 'model_4', 'resnet', NULL, 'segmentation', 'volume2');
INSERT INTO inference.model (id, description, model_name, network_name, properties, task_name, volume_id)
VALUES (5, NULL, 'model_5', 'fcnn', NULL, 'segmentation', 'volume2');
INSERT INTO inference.model (id, description, model_name, network_name, properties, task_name, volume_id)
VALUES (6, NULL, 'model_6', 'deeplabv3', NULL, 'segmentation', 'volume2');
INSERT INTO inference.model (id, description, model_name, network_name, properties, task_name, volume_id)
VALUES (7, NULL, 'model_7', 'resnet', NULL, 'anomaly', 'volume3');
INSERT INTO inference.model (id, description, model_name, network_name, properties, task_name, volume_id)
VALUES (8, NULL, 'model_8', 'fcnn', NULL, 'anomaly', 'volume3');
INSERT INTO inference.model (id, description, model_name, network_name, properties, task_name, volume_id)
VALUES (9, NULL, 'model_9', 'deeplabv3', NULL, 'anomaly', 'volume3');


INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (1, TIMESTAMPTZ '2022-06-24 10:03:22.105282Z', 'test_user1', NULL, 'model_1.mar', NULL, NULL, 1, NULL, NULL, TIMESTAMPTZ '2022-06-24 10:03:22.105282Z', 'test_user1', '1');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (2, TIMESTAMPTZ '2022-06-24 03:40:37.105282Z', 'test_user1', NULL, 'model_2.mar', NULL, NULL, 1, NULL, NULL, TIMESTAMPTZ '2022-06-24 03:40:37.105282Z', 'test_user1', '2');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (3, TIMESTAMPTZ '2022-06-24 10:11:19.105282Z', 'test_user1', NULL, 'model_1.mar', NULL, NULL, 2, NULL, NULL, TIMESTAMPTZ '2022-06-24 10:11:19.105282Z', 'test_user1', '1');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (4, TIMESTAMPTZ '2022-06-24 05:32:09.105282Z', 'test_user1', NULL, 'model_2.mar', NULL, NULL, 2, NULL, NULL, TIMESTAMPTZ '2022-06-24 05:32:09.105282Z', 'test_user1', '2');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (5, TIMESTAMPTZ '2022-06-24 04:05:14.105282Z', 'test_user1', NULL, 'model_1.mar', NULL, NULL, 3, NULL, NULL, TIMESTAMPTZ '2022-06-24 04:05:14.105282Z', 'test_user1', '1');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (6, TIMESTAMPTZ '2022-06-24 07:15:19.105282Z', 'test_user1', NULL, 'model_2.mar', NULL, NULL, 3, NULL, NULL, TIMESTAMPTZ '2022-06-24 07:15:19.105282Z', 'test_user1', '2');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (7, TIMESTAMPTZ '2022-06-23 11:30:47.105282Z', 'test_user1', NULL, 'model_1.mar', NULL, NULL, 4, NULL, NULL, TIMESTAMPTZ '2022-06-23 11:30:47.105282Z', 'test_user1', '1');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (8, TIMESTAMPTZ '2022-06-23 01:10:05.105282Z', 'test_user1', NULL, 'model_2.mar', NULL, NULL, 4, NULL, NULL, TIMESTAMPTZ '2022-06-23 01:10:05.105282Z', 'test_user1', '2');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (9, TIMESTAMPTZ '2022-06-23 20:36:43.105282Z', 'test_user1', NULL, 'model_1.mar', NULL, NULL, 5, NULL, NULL, TIMESTAMPTZ '2022-06-23 20:36:43.105282Z', 'test_user1', '1');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (10, TIMESTAMPTZ '2022-06-22 23:02:19.105282Z', 'test_user1', NULL, 'model_2.mar', NULL, NULL, 5, NULL, NULL, TIMESTAMPTZ '2022-06-22 23:02:19.105282Z', 'test_user1', '2');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (11, TIMESTAMPTZ '2022-06-23 14:04:56.105282Z', 'test_user1', NULL, 'model_1.mar', NULL, NULL, 6, NULL, NULL, TIMESTAMPTZ '2022-06-23 14:04:56.105282Z', 'test_user1', '1');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (12, TIMESTAMPTZ '2022-06-23 23:14:13.105282Z', 'test_user1', NULL, 'model_2.mar', NULL, NULL, 6, NULL, NULL, TIMESTAMPTZ '2022-06-23 23:14:13.105282Z', 'test_user1', '2');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (13, TIMESTAMPTZ '2022-06-22 13:12:22.105282Z', 'test_user1', NULL, 'model_1.mar', NULL, NULL, 7, NULL, NULL, TIMESTAMPTZ '2022-06-22 13:12:22.105282Z', 'test_user1', '1');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (14, TIMESTAMPTZ '2022-06-24 04:34:53.105282Z', 'test_user1', NULL, 'model_2.mar', NULL, NULL, 7, NULL, NULL, TIMESTAMPTZ '2022-06-24 04:34:53.105282Z', 'test_user1', '2');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (15, TIMESTAMPTZ '2022-06-22 18:44:34.105282Z', 'test_user1', NULL, 'model_1.mar', NULL, NULL, 8, NULL, NULL, TIMESTAMPTZ '2022-06-22 18:44:34.105282Z', 'test_user1', '1');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (16, TIMESTAMPTZ '2022-06-23 13:31:49.105282Z', 'test_user1', NULL, 'model_2.mar', NULL, NULL, 8, NULL, NULL, TIMESTAMPTZ '2022-06-23 13:31:49.105282Z', 'test_user1', '2');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (17, TIMESTAMPTZ '2022-06-22 13:13:21.105282Z', 'test_user1', NULL, 'model_1.mar', NULL, NULL, 9, NULL, NULL, TIMESTAMPTZ '2022-06-22 13:13:21.105282Z', 'test_user1', '1');
INSERT INTO inference.model_version (id, create_date, create_user, description, filename, load_date, load_user, model_id, properties, status, update_date, update_user, version)
VALUES (18, TIMESTAMPTZ '2022-06-23 11:45:25.105282Z', 'test_user1', NULL, 'model_2.mar', NULL, NULL, 9, NULL, NULL, TIMESTAMPTZ '2022-06-23 11:45:25.105282Z', 'test_user1', '2');


INSERT INTO inference.default_model_version (id, model_id, model_version_id)
VALUES (1, 1, 1);
INSERT INTO inference.default_model_version (id, model_id, model_version_id)
VALUES (2, 2, 3);
INSERT INTO inference.default_model_version (id, model_id, model_version_id)
VALUES (3, 3, 5);
INSERT INTO inference.default_model_version (id, model_id, model_version_id)
VALUES (4, 4, 7);
INSERT INTO inference.default_model_version (id, model_id, model_version_id)
VALUES (5, 5, 9);
INSERT INTO inference.default_model_version (id, model_id, model_version_id)
VALUES (6, 6, 11);
INSERT INTO inference.default_model_version (id, model_id, model_version_id)
VALUES (7, 7, 13);
INSERT INTO inference.default_model_version (id, model_id, model_version_id)
VALUES (8, 8, 15);
INSERT INTO inference.default_model_version (id, model_id, model_version_id)
VALUES (9, 9, 17);


INSERT INTO inference.worker (id, cpu_count, cpu_memory, description, gpu_count, gpu_memory, model_version_id, port, properties, server_id, serving_type)
VALUES ('worker_1', 0, 0, NULL, 2, 512000000, 1, 8193, '{"InferenceApi":8193, "ManagementApi":8194}', 'server_1', 'torch');


CREATE UNIQUE INDEX ix_default_model_version_model_id ON inference.default_model_version (model_id);


CREATE UNIQUE INDEX ix_default_model_version_model_version_id ON inference.default_model_version (model_version_id);


CREATE UNIQUE INDEX ix_model_model_name ON inference.model (model_name);


CREATE INDEX ix_model_volume_id ON inference.model (volume_id);


CREATE UNIQUE INDEX ix_model_version_model_id_version_filename ON inference.model_version (model_id, version, filename);


CREATE UNIQUE INDEX ix_volume_title ON inference.volume (title);


CREATE UNIQUE INDEX ix_volume_uri ON inference.volume (uri);


CREATE UNIQUE INDEX ix_worker_model_version_id ON inference.worker (model_version_id);


CREATE INDEX ix_worker_server_id ON inference.worker (server_id);


SELECT setval(
    pg_get_serial_sequence('inference.model', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM inference.model) + 1,
        nextval(pg_get_serial_sequence('inference.model', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('inference.model_version', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM inference.model_version) + 1,
        nextval(pg_get_serial_sequence('inference.model_version', 'id'))),
    false);
SELECT setval(
    pg_get_serial_sequence('inference.default_model_version', 'id'),
    GREATEST(
        (SELECT MAX(id) FROM inference.default_model_version) + 1,
        nextval(pg_get_serial_sequence('inference.default_model_version', 'id'))),
    false);


